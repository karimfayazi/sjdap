// Script to help create .env.local file with correct SQL Server connection
// Run with: node create-env-file.js

const fs = require('fs');
const path = require('path');
const sql = require('mssql');

async function createEnvFile() {
    console.log('='.repeat(70));
    console.log('SQL Server Connection Helper');
    console.log('='.repeat(70));
    console.log('\nThis script will help you create the .env.local file.\n');

    // First, let's try to find the port by checking common ports
    console.log('STEP 1: Testing common SQL Server ports...\n');
    
    const commonPorts = [1433, 1434, 49152, 49153, 49154, 49155, 49156, 49157];
    let foundPort = null;
    let foundServer = null;

    for (const port of commonPorts) {
        const attempts = [
            { name: `SJDAP-MS-LT-KF:${port}`, conn: `Server=SJDAP-MS-LT-KF,${port};Database=db_PE;Integrated Security=true;TrustServerCertificate=true;Connection Timeout=5;` },
            { name: `localhost:${port}`, conn: `Server=localhost,${port};Database=db_PE;Integrated Security=true;TrustServerCertificate=true;Connection Timeout=5;` },
            { name: `127.0.0.1:${port}`, conn: `Server=127.0.0.1,${port};Database=db_PE;Integrated Security=true;TrustServerCertificate=true;Connection Timeout=5;` },
        ];

        for (const attempt of attempts) {
            try {
                process.stdout.write(`Testing ${attempt.name}... `);
                const pool = await sql.connect(attempt.conn);
                console.log('✓ SUCCESS!\n');
                
                const result = await pool.request().query('SELECT DB_NAME() as dbname');
                if (result.recordset[0].dbname === 'db_PE') {
                    console.log(`  ✓ Connected to correct database: ${result.recordset[0].dbname}`);
                    console.log(`\n  Working connection string:`);
                    console.log(`  ${attempt.conn}`);
                    
                    foundPort = port;
                    foundServer = attempt.conn.includes('SJDAP-MS-LT-KF') ? 'SJDAP-MS-LT-KF' : 
                                 attempt.conn.includes('localhost') ? 'localhost' : '127.0.0.1';
                    
                    await pool.close();
                    break;
                }
                await pool.close();
            } catch (error) {
                console.log('✗ Failed');
            }
        }
        
        if (foundPort) break;
    }

    if (foundPort) {
        const connectionString = `Server=${foundServer},${foundPort};Database=db_PE;Integrated Security=true;TrustServerCertificate=true;Connection Timeout=60;Request Timeout=120000;Encrypt=false`;
        
        const envContent = `# SQL Server PE Database Connection
# Auto-generated by create-env-file.js
MSSQL_PE_DB_CONNECTION="${connectionString}"
`;

        const envPath = path.join(process.cwd(), '.env.local');
        fs.writeFileSync(envPath, envContent);
        
        console.log('\n' + '='.repeat(70));
        console.log('✓ .env.local file created successfully!');
        console.log('='.repeat(70));
        console.log(`\nFile location: ${envPath}`);
        console.log(`\nConnection string: ${connectionString}`);
        console.log('\nNext steps:');
        console.log('1. Restart your Next.js application');
        console.log('2. The connection should now work\n');
    } else {
        console.log('\n' + '='.repeat(70));
        console.log('Could not automatically find the port');
        console.log('='.repeat(70));
        console.log('\nPlease follow these manual steps:\n');
        console.log('1. Open SQL Server Configuration Manager');
        console.log('2. Go to: SQL Server Network Configuration → Protocols for SQLEXPRESS');
        console.log('3. Double-click "TCP/IP" → IP Addresses tab');
        console.log('4. Scroll to "IPAll" section at the bottom');
        console.log('5. Note the "TCP Dynamic Ports" value (e.g., 1433, 49152)');
        console.log('\n6. Create .env.local file manually with this content:');
        console.log('   MSSQL_PE_DB_CONNECTION="Server=SJDAP-MS-LT-KF,<PORT>;Database=db_PE;Integrated Security=true;TrustServerCertificate=true;Connection Timeout=60;Request Timeout=120000;Encrypt=false"');
        console.log('   (Replace <PORT> with the port from step 5)');
        console.log('\n7. Restart your Next.js application\n');
    }
}

createEnvFile().catch(console.error);

